#!groovy
node {
  try {
    stage('Build') {
      git credentialsId: 'e093579e-dd48-4ec2-a6f5-cd0150ab2eae', url: 'git@github.com:papitoio/nblog-api.git'
      env.RACK_ENV = 'development'
      ruby 'bundle install'
      ruby 'rspec --format progress --format RspecJunitFormatter --out rspec.xml'
      junit 'rspec.xml'
     }
     stage('Deploy to QA') {
       deploy('qa')
     }
     stage('Run Funciontal Tests') {
       ruby 'cd tests && bundle install && cucumber'
       cucumber fileIncludePattern: 'funcional_tests.json', jsonReportDirectory: 'tests'
       junit 'tests/results/*.xml'
     }
     stage('Deploy to UAT') {
       deploy('uat')
     }
     stage('Run Acceptance Tests') {
       ruby 'cd tests && bundle install && cucumber -p uat'
     }
     stage('Deploy to Production') {
       deploy_production()
       ruby 'cd tests && bundle install && cucumber -p production'
     }
  }
  catch (err) {
		currentBuild = 'Deu Ruim :('
		throw err
	}
}

def ruby(String commands) {
    sh "bash -c 'source ~/.bashrc && rbenv global 2.3.3 && ${commands}'"
}

def deploy(String env) {
  sh "rm -rf .git && git init"
  sh "heroku git:remote -a nblog-api-${env}"
  sh "git add . && git commit -m 'deploy'"
  sh "git push heroku master --force"
}

def deploy_production() {
  sh "rm -rf .git && git init"
  sh "heroku git:remote -a nblog-api"
  sh "git add . && git commit -m 'deploy'"
  sh "git push heroku master --force"
}
